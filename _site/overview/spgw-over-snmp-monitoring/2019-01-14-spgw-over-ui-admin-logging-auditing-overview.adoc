= SPGateway Logging and Auditing Overview
:page-layout: post
:page-category: Overview

== Introduction

The purpose of this document is to explain the logging implementation in the SPGateway system.
SPGateway writes all events and actions to the logs for auditing purposes.
It includes administrative actions and user access and authorization states.

== Log Format

SPGateway logs the audit events in the following format:
----
TIMESTAMP HOSTNAME APPLICATION PROCID COMPONENT SUB-COMPONENT LOG_LEVEL EVENT [STRUCTURED_DATA] MESSAGE
----

.Log Statement Fields
[width="80%", cols="4, 8" options="header"]
|===
|Field |Description
|TIMESTAMP |Current system date and time
|HOSTNAME |Machine hostname
|APPLICATION |SPGateway
|PROC_ID |Process layer
|COMPONENT |Component of the process
|SUB-COMPONENT |Sub-component of the process
|LOG_LEVEL |Log level
|EVENT |Type of event
|STRUCTURED_DATA |Data related to the occurred event important for analysis/troubleshooting
|MESSAGE |Readable message
|===

== Events and Monitoring

SPGateway can be customized to send logs to any external log monitoring system.
It writes all important events to the log that can be used for monitoring.
The following tables list the events generated by SPGateway and the keywords to implement monitoring.

=== Web Console

==== Startup

.Log Identifier
[width="50%", options="header"]
|===
|Field |Value
|PROC_ID |WEB_CONSOLE
|COMPONENT |
|SUB-COMPONENT |
|EVENT |SYSTEM_STARTUP
|===

. Initial authentication with access layer success
.. *Log Level*: INFO
.. *Message*: Startup complete, system ready.
.. *Log Sample*:
+
----
Oct  9 09:47:02 spgateway01 WEB_CONSOLE - - INFO SYSTEM_STARTUP [] Startup complete, system ready.
----

==== User Login

.Log Identifier
[width="50%", options="header"]
|===
|Field |Value
|PROC_ID |WEB_CONSOLE
|COMPONENT | AUTHN
|SUB-COMPONENT | LOCAL
|EVENT |USER_LOGIN
|===

.Structured Data
[width="100%", cols="2,6", options="header"]
|===
|Field |Description
|SESSION_ID |This is the internal session ID created for the user session. This can be used to track user activity.
|SUBJECT | Username (admin)
|TYPE |LOCAL
|RESULT |PASS/FAIL
|REASON |Reason of successful/unsuccessful authentication
|REMOTE_IP |User remote IP address
|USER_AGENT |User browser info
|===

. Initial authentication with access layer success
.. *Log Level*: INFO
.. *Message*: User login success: <Username>
.. *Log Sample*:
+
----
Oct  9 09:53:08 spgateway01 WEB_CONSOLE AUTHN LOCAL INFO USER_LOGIN [SESSION_ID="xNQ45qBSM7iDSh3SJMYRIxud2NOEKKxCRE2xsHSH" SUBJECT="admin" TYPE="LOCAL" RESULT="FAIL" REASON="INVALID_CREDENTIALS" REMOTE_IP="-" USER_AGENT="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/61.0.3163.100 Safari/537.36"] User login failed: admin

Oct  9 09:53:17 spgateway01 WEB_CONSOLE AUTHN LOCAL INFO USER_LOGIN [SESSION_ID="xNQ45qBSM7iDSh3SJMYRIxud2NOEKKxCRE2xsHSH" SUBJECT="admin" TYPE="LOCAL" RESULT="PASS" REASON="VALID_CREDENTIALS" REMOTE_IP="-" USER_AGENT="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/61.0.3163.100 Safari/537.36"] User login success: admin
----

==== User Logout

.Log Identifier
[width="50%", options="header"]
|===
|Field |Value
|PROC_ID |WEB_CONSOLE
|COMPONENT |SESSION
|SUB-COMPONENT |LOCAL
|EVENT |USER_LOGIN
|===

.Structured Data
[width="100%", cols="2,5", options="header"]
|===
|Field |Description
|SESSION_ID |This is the internal session ID created for the user session. This can be used to track user activity.
|SUBJECT |Username (admin)
|REASON |USER_ACTION
|REMOTE_IP |User remote IP address
|USER_AGENT |User browser info
|===

. Initial authentication with access layer success
.. *Log Level*: INFO
.. *Message*: User logout: admin
.. *Log Sample*:
+
----
Oct  9 09:58:04 spgateway01 WEB_CONSOLE SESSION LOCAL INFO USER_LOGOUT [SESSION_ID="xNQ45qBSM7iDSh3SJMYRIxud2NOEKKxCRE2xsHSH" SUBJECT="admin" REASON="USER_ACTION" REMOTE_IP="-" USER_AGENT="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/61.0.3163.100 Safari/537.36"] User logout: admin
----

==== System SPGateway Events

===== Accept License Agreement

.Log Identifier
[width="50%", options="header"]
|===
|Field |Value
|PROC_ID |WEB_CONSOLE
|COMPONENT |SPGW
|SUB-COMPONENT |SPGW_LICENSE
|EVENT |SYSTEM_SPGW_EVENT
|===

.Structured Data
[width="100%", cols="2,5", options="header"]
|===
|Field |Description
|GUID |System identifier
|HOST |SPGateway virtual hostname
|REASON |SPGW_ACCEPT_LICENSE
|SESSION_ID |This is the internal session ID created for the user session. This can be used to track user activity.
|SUBJECT |Username
|REMOTE_IP |User remote IP address
|USER_AGENT |User browser info
|===

. Accept SPGateway License Agreement
.. *Log Level*: INFO
.. *REASON*: SPGW_ACCEPT_LICENSE
.. *Message*: Accepted SPGateway license agreement on host: <SPGateway Hostname>
.. *Log Sample*:
+
----
Oct  9 13:59:59 spgateway01 WEB_CONSOLE SPGW SPGW_LICENSE INFO SYSTEM_SPGW_EVENT [GUID="82847f5a-2954-4beb-ad47-98d7ab4bdfe2" HOST="<host URL>" COOKIE_DOMAIN="<cookie domain>" REASON="SPGW_ACCEPT_LICENSE" SESSION_ID="z8PtxiHk8KPi3Ft3Q-9OSOsODZUaaG04nn91roW5" SUBJECT="admin" REMOTE_IP="-" USER_AGENT="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/61.0.3163.100 Safari/537.36"] Accepted SPGateway license agreement on host: '<host URL>'
----

===== SPGateway Setup

.Log Identifier
[width="50%", options="header"]
|===
|Field |Value
|PROC_ID |WEB_CONSOLE
|COMPONENT |SPGW
|SUB-COMPONENT |
|EVENT |SYSTEM_SPGW_SETUP
|===

.Structured Data
[width="100%", cols="2,5", options="header"]
|===
|Field |Description
|GUID |System identifier
|HOST |SPGateway virtual hostname
|COOKIE_DOMAIN |SPGateway cookie domain
|REASON |SYSTEM_SPGW_SETUP
|SESSION_ID |This is the internal session ID created for the user session. This can be used to track user activity.
|SUBJECT |Username
|REMOTE_IP |User remote IP address
|USER_AGENT |User browser info
|===

. Set up SPGateway
.. *Log Level*: INFO
.. *REASON*: SPGW_ACCEPT_LICENSE
.. *Message*: SPGateway event host: '<SPGateway Hostname>' action: 'SYSTEM_SPGW_SETUP'
.. *Log Sample*:
+
----
Oct  9 13:59:59 spgateway01 WEB_CONSOLE SPGW - INFO SYSTEM_SPGW_SETUP [GUID="82847f5a-2954-4beb-ad47-98d7ab4bdfe2" HOST="<host URL>" COOKIE_DOMAIN="<cookie domain>" REASON="SYSTEM_SPGW_SETUP" SESSION_ID="z8PtxiHk8KPi3Ft3Q-9OSOsODZUaaG04nn91roW5" SUBJECT="admin" REMOTE_IP="-" USER_AGENT="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/61.0.3163.100 Safari/537.36"] SPGateway event host: '<host URL>' action: 'SYSTEM_SPGW_SETUP'
----

===== SPGateway Reset

.Log Identifier
[width="50%", options="header"]
|===
|Field |Value
|PROC_ID |WEB_CONSOLE
|COMPONENT |SPGW
|SUB-COMPONENT |
|EVENT |SYSTEM_SPGW_RESET
|===

.Structured Data
[width="100%", cols="2,5", options="header"]
|===
|Field |Description
|GUID |System identifier
|HOST |SPGateway virtual hostname
|COOKIE_DOMAIN |SPGateway cookie domain
|REASON |SYSTEM_SPGW_RESET
|SESSION_ID |This is the internal session ID created for the user session. This can be used to track user activity.
|SUBJECT |Username
|REMOTE_IP |User remote IP address
|USER_AGENT |User browser info
|===

. Set up SPGateway
.. *Log Level*: INFO
.. *REASON*: SPGW_ACCEPT_LICENSE
.. *Message*: SPGateway event host: '<SPGateway Hostname'> action: 'SYSTEM_SPGW_RESET'
.. *Log Sample*:
+
----
Oct  9 14:23:17 spgateway01 WEB_CONSOLE SPGW - INFO SYSTEM_SPGW_RESET [GUID="82847f5a-2954-4beb-ad47-98d7ab4bdfe2" HOST="<host URL>" COOKIE_DOMAIN="<cookie domain>" REASON="SYSTEM_SPGW_RESET" SESSION_ID="ThiCzcAPvxVQSkeSi3AIqJUBTIGyJDIOwGc4DRsh" SUBJECT="admin" REMOTE_IP="-" USER_AGENT="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/61.0.3163.100 Safari/537.36"] SPGateway event host: '<host URL>' action: 'SYSTEM_SPGW_RESET'
----

==== System IDP Status

.Log Identifier
[width="50%", options="header"]
|===
|Field |Value
|PROC_ID |WEB_CONSOLE
|COMPONENT |IDP
|SUB-COMPONENT | LOCAL
|EVENT |SYSTEM_IDP_STATUS
|===

.Structured Data
[width="100%", cols="2,5", options="header"]
|===
|Field |Description
|NAME |IDP Name
|DOMAIN |IDP Domain
|TYPE |IDP Type
|RESULT |PASS/FAIL
|REASON |VALID / INVALID_NETWORK_CONN (FAIL), INVALID_TOKEN (FAIL)
|===

. Valid IDP
.. *Log Level*: INFO
.. *RESULT*: PASS
.. *REASON*: VALID
.. *Message*: Success confirming IDP status with: <IDP Domain>
.. *Log Sample*:
+
----
Oct  9 04:00:00 spgateway WEB_CONSOLE IDP LOCAL INFO SYSTEM_IDP_STATUS [NAME="<IDP Name> IDP" DOMAIN="<IDP URL>" TYPE="<Identity Provider type>" RESULT="PASS" REASON="VALID"] Success confirming IDP status with: <IDP URL>
----
+
. IDP No longer network reachable
.. *Log Level*: ALERT
.. *RESULT*: FAIL
.. *REASON*: INVALID_NETWORK_CONN
.. *Message*: Failure confirming connectivity with IDP: <IDP Domain>. Please verify your network configuration.
.. *Log Sample*:
+
----
Oct  9 04:02:00 spgateway WEB_CONSOLE IDP LOCAL INFO SYSTEM_IDP_STATUS [NAME="<IDP Name> IDP" DOMAIN="<IDP URL>" TYPE="<Identity Provider type>" RESULT="FAIL" REASON="INVALID_NETWORK_CONN"] Failure confirming connectivity with IDP: <IDP URL>>. Please verify your network configuration.
----
+
. IDP Security Key is no longer valid
.. *Log Level*: ALERT
.. *RESULT*: FAIL
.. *REASON*: INVALID_TOKEN
.. *Message*: Failure validating security token with IDP: <IDP Domain>. Please validate token exists and is enabled.
.. *Log Sample*:
+
----
Oct  9 04:02:23 spgateway WEB_CONSOLE IDP LOCAL INFO SYSTEM_IDP_STATUS [NAME="<IDP Name> IDP" DOMAIN="<IDP URL>" TYPE="<Identity Provider type>" RESULT="FAIL" REASON="INVALID_NETWORK_CONN"] Failure validating security token with IDP: <IDP Domain>. Please validate token exists and is enabled.
----

==== System KRB5 Events

.Log Identifier
[width="50%", options="header"]
|===
|Field |Value
|PROC_ID |WEB_CONSOLE
|COMPONENT |KRB5
|SUB-COMPONENT |
|EVENT |SYSTEM_KRB5_EVENT
|===

.Structured Data
[width="100%", cols="2,5", options="header"]
|===
|Field |Description
|REALM |Kerberos Realm
|REASON |CREATE/UPDATE/DELETE
|SESSION_ID |This is an internal session ID created for the user session. This can be used to track user activity.
|SUBJECT |Username
|REMOTE_IP |User remote IP address
|USER_AGENT |User browser info
|===

. Add Kerberos Configuration
.. *Log Level*: INFO
.. *REASON*: CREATE
.. *Message*: Kerberos Realm: '<Kerberos Realm>' action: 'CREATE'
.. *Log Sample*:
+
----
Oct  9 13:06:21 spgateway01 WEB_CONSOLE KRB5 - INFO SYSTEM_KRB5_EVENT [REALM="<Kerberos Realm>" REASON="CREATE" SESSION_ID="lAf-w_UtYs2JmxzajaAj2tChuaSk-lKWQK1CAibO" SUBJECT="admin" REMOTE_IP="-" USER_AGENT="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/61.0.3163.100 Safari/537.36"] Kerberos Realm: '<Kerberos Realm>' action: 'CREATE'
----
+
. Update Kerberos Configuration
.. *Log Level*: INFO
.. *REASON*: UPDATE
.. *Message*: Kerberos Realm: '<Kerberos Realm>' action: 'UPDATE'
.. *Log Sample*:
+
----
Oct  9 13:06:40 spgateway01 WEB_CONSOLE KRB5 - INFO SYSTEM_KRB5_EVENT [REALM="<Kerberos Realm>" REASON="UPDATE" SESSION_ID="lAf-w_UtYs2JmxzajaAj2tChuaSk-lKWQK1CAibO" SUBJECT="admin" REMOTE_IP="-" USER_AGENT="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/61.0.3163.100 Safari/537.36"] Kerberos Realm: '<Kerberos Realm>' action: 'UPDATE'
----
+
. Delete Kerberos Configuration
.. *Log Level*: INFO
.. *REASON*: DELETE
.. *Message*: Kerberos Realm: '<Kerberos Realm>' action: 'DELETE'
.. *Log Sample*:
+
----
Oct  9 13:06:53 spgateway01 WEB_CONSOLE KRB5 - INFO SYSTEM_KRB5_EVENT [REALM="<Kerberos Realm>" REASON="DELETE" SESSION_ID="lAf-w_UtYs2JmxzajaAj2tChuaSk-lKWQK1CAibO" SUBJECT="admin" REMOTE_IP="-" USER_AGENT="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/61.0.3163.100 Safari/537.36"] Kerberos Realm: '<Kerberos Realm>' action: 'DELETE'
----

==== System App Events

.Log Identifier
[width="50%", options="header"]
|===
|Field |Value
|PROC_ID |WEB_CONSOLE
|COMPONENT |APP
|SUB-COMPONENT |
|EVENT |SYSTEM_APP_EVENT
|===

.Structured Data
[width="100%", cols="2,5", options="header"]
|===
|Field |Description
|GUID |Application identifier
|NAME |Application name
|TYPE |Application type
|DOMAIN |Public domain of application
|IDP |IDP Domain
|IDP_TYPE |IDP Type
|REASON |CREATE, UPDATE, DELETE, ACTIVATE, DEACTIVATE
|SESSION_ID |This is an internal session ID created for the user session. This can be used to track user activity.
|SUBJECT |Username
|REMOTE_IP |User remote IP address
|USER_AGENT |User browser info
|===

. Create Application
.. *Log Level*: INFO
.. *REASON*: CREATE
.. *Message*: Application: '<Application Name>' action: 'CREATE'
.. *Log Sample*:
+
----
Oct  9 11:30:48 spgateway01 WEB_CONSOLE APP - INFO SYSTEM_APP_EVENT [GUID="93d2e78a-c6b7-4c27-83c8-15c2b783d3bb" NAME="Sample Header App" TYPE="SAMPLEHEADER2015_APP" DOMAIN="<App Domain URL>" IDP="<IDP URL>" IDP_TYPE="<Identity Provider type>" REASON="CREATE" SESSION_ID="3dKU4yqIlHkcRUeGb9f9Dh6OSgFjHq3hIMVktx7h" SUBJECT="admin" REMOTE_IP="-" USER_AGENT="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/61.0.3163.100 Safari/537.36"] Application: 'Sample Header App' action: 'CREATE'
----
+
. Update Application
.. *Log Level*: INFO
.. *REASON*: UPDATE
.. *Message*: Application: '<Application Name'> action: 'UPDATE'
.. *Log Sample*:
+
----
Oct  9 11:39:19 spgateway01 WEB_CONSOLE APP - INFO SYSTEM_APP_EVENT [GUID="93d2e78a-c6b7-4c27-83c8-15c2b783d3bb" NAME="Sample Header App" TYPE="SAMPLEHEADER2015_APP" DOMAIN="<App Domain URL>" IDP="<IDP URL>" IDP_TYPE="<Identity Provider type>" REASON="UPDATE" SESSION_ID="3dKU4yqIlHkcRUeGb9f9Dh6OSgFjHq3hIMVktx7h" SUBJECT="admin" REMOTE_IP="-" USER_AGENT="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/61.0.3163.100 Safari/537.36"] Application: 'Sample Header App' action: 'UPDATE'
----
+
. Activate Application
.. *Log Level*: INFO
.. *REASON*: ENABLE
.. *Message*: Application: '<Application Name'> action: 'ENABLE'
.. *Log Sample*:
+
----
Oct  9 11:40:56 spgateway01 WEB_CONSOLE APP - INFO SYSTEM_APP_EVENT [GUID="93d2e78a-c6b7-4c27-83c8-15c2b783d3bb" NAME="Sample Header App" TYPE="SAMPLEHEADER2015_APP" DOMAIN="<App Domain URL>" IDP="<IDP URL>" IDP_TYPE="<Identity Provider type>" REASON="ENABLE" SESSION_ID="3dKU4yqIlHkcRUeGb9f9Dh6OSgFjHq3hIMVktx7h" SUBJECT="admin" REMOTE_IP="-" USER_AGENT="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/61.0.3163.100 Safari/537.36"] Application: 'Sample Header App' action: 'ENABLE'
----
+
. Deactivate Application
.. *Log Level*: INFO
.. *REASON*: DISABLE
.. *Message*: Application '<Application Name>' action: 'DISABLE'
.. *Log Sample*:
+
----
Oct  9 11:40:08 spgateway01 WEB_CONSOLE APP - INFO SYSTEM_APP_EVENT [GUID="93d2e78a-c6b7-4c27-83c8-15c2b783d3bb" NAME="Sample Header App" TYPE="SAMPLEHEADER2015_APP" DOMAIN="<App Domain URL>" IDP="<IDP URL>" IDP_TYPE="<Identity Provider type>" REASON="DISABLE" SESSION_ID="3dKU4yqIlHkcRUeGb9f9Dh6OSgFjHq3hIMVktx7h" SUBJECT="admin" REMOTE_IP="-" USER_AGENT="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/61.0.3163.100 Safari/537.36"] Application: 'Sample Header App' action: 'DISABLE'
----
+
. Delete Application
.. *Log Level*: INFO
.. *REASON*: DELETE
.. *Message*: Application: '<Application Name>' action: 'DELETE'
.. *Log Sample*:
+
----
Oct  9 11:43:09 spgateway01 WEB_CONSOLE APP - INFO SYSTEM_APP_EVENT [GUID="93d2e78a-c6b7-4c27-83c8-15c2b783d3bb" NAME="Sample Header App" TYPE="SAMPLEHEADER2015_APP" DOMAIN="<App Domain URL>" IDP="<IDP URL>" IDP_TYPE="<Identity Provider type>" REASON="DELETE" SESSION_ID="3dKU4yqIlHkcRUeGb9f9Dh6OSgFjHq3hIMVktx7h" SUBJECT="admin" REMOTE_IP="-" USER_AGENT="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/61.0.3163.100 Safari/537.36"] Application: 'Sample Header App' action: 'DELETE'
----

=== Gateway

==== Authentication

.Log Identifier
[width="50%", options="header"]
|===
|Field |Value
|PROC_ID |ACCESS
|COMPONENT |AUTHN
|SUB-COMPONENT |SAML
|EVENT |USER_AUTHN
|===

.Structured Data
[width="100%", cols="3,5", options="header"]
|===
|Field |Description
|SESSION_ID |This is an internal session ID created for the user session. This can be used to track user activity.
|SESSION_AUTH |Temporary session ID
|SUBJECT |Username sent with SAML assertion
|TYPE |SAML or the involved authentication module
|SOURCE |EntityID
|SOURCE_TYPE |<Identity Provider type>, IDP_IDCS, IDP_SAML_LOCAL
|SOURCE_DOMAIN |IDP domain
|SOURCE_AUTHN_TYPE |The authNcontext type from the SAML assertion
|APP |Application name that is requested
|APP_DOMAIN |Public domain of the requested application
|RESULT |PASS/FAIL
|REASON |INVALID_RELAY_STATE
|REMOTE_IP |User remote IP address
|USER_AGENT |User browser info
|MSG |The end user message
|===

. Initial authentication with access layer success
.. *Log Level*: INFO
.. *Message*: User login:<Username>
.. *RESULT*: PASS
.. *REASON*: Valid SAML Assertion
.. *Log Sample*:
+
----
Oct  5 22:57:05 spgateway01 SPGATEWAY ACCESS AUTHN SAML INFO USER_AUTHN [SESSION_ID="_6f89fde9801702d4055216fad847dc889536592839" SESSION_AUTH="_99077d998f2b3c0f65ee8dbea6abd1fb389a6e18a4" SUBJECT="<User login name>" TYPE="SAML_2_0" SOURCE="IDP Source URL" SOURCE_TYPE="<Identity Provider type>" SOURCE_DOMAIN="<IDP URL>" SOURCE_AUTHN_TYPE="urn:oasis:names:tc:SAML:2.0:ac:classes:PasswordProtectedTransport" APP="Sample Header App" APP_DOMAIN="<App Domain URL>" RESULT="PASS" REASON="Valid SAML Assertion" REMOTE_IP="192.168.10.20" USER_AGENT="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/61.0.3163.100 Safari/537.36"] User login:<User login name>
----
+
. Time not in sync
.. *Log Level*: ERROR
.. *RESULT*: FAIL
.. *REASON*: INVALID_RELAYSTATE
.. *Message*: Failed RelayState validation. RelayState:<Bad RelayState> changed to:<Expected RelayState>
.. *Log Sample*:
+
----
Oct 29 10:05:14 spgateway01 SPGATEWAY ACCESS AUTHN SAML ERROR USER_AUTHN [TYPE="SAML_2_0" TRACKER_ID="cd6525dee8" SOURCE="https://<IDP URL>/app/template_saml_2_0/exkckwwaxvY3crKhn0h7/sso/saml" RESULT="FAIL" REASON="Invalid SAML Assertion" REMOTE_IP="192.168.10.192" USER_AGENT="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.62 Safari/537.36"] Received an assertion that has expired. Check clock synchronization on IdP and SP.
----
+
. RelayState failed validation
.. *Log Level*: WARN
.. *RESULT*: FAIL
.. *REASON*: Invalid SAML Assertion
.. *Message*: Received an assertion that was expired. Check clock synchronization on IdP and SP.
.. *Log Sample*:
+
----
Oct  6 12:56:34 spgateway01 SPGATEWAY ACCESS AUTHN SAML WARN USER_AUTHN [SESSION_ID="_a9b67d3c0007f1614c4ca7ae991e6803d340a3e252" SESSION_AUTH="-" SUBJECT="<User login name>" TYPE="SAML_2_0" SOURCE="http://www.okta.com/exkca4yif7Qpdc6en0h7" SOURCE_TYPE="<Identity Provider type>" SOURCE_DOMAIN="<IDP URL>" SOURCE_AUTHN_TYPE="urn:oasis:names:tc:SAML:2.0:ac:classes:PasswordProtectedTransport" APP="Sample Header App" APP_DOMAIN="<App Domain URL>" RESULT="FAIL" REASON="INVALID_RELAYSTATE" REMOTE_IP="192.168.10.165" USER_AGENT="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/61.0.3163.100 Safari/537.36"] Failed RelayState validation. RelayState:https://header.icsynergy.com changed to:https://<App Domain URL>
----
+
. SPGateway SAML endpoint is accessed directly
.. *Log Level*: ERROR
.. *RESULT*: FAIL
.. *REASON*: Invalid SAML assertion
.. *Message*: Unable to find the current binding.
.. *Log Sample*:
+
----
Oct 26 10:21:02 spgateway01 SPGATEWAY ACCESS AUTHN SAML ERROR USER_AUTHN [TYPE="SAML_2_0" TRACKER_ID="cd6525dee8" SOURCE="unknown" RESULT="FAIL" REASON="Invalid SAML Assertion" REMOTE_IP="192.168.10.192" USER_AGENT="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.62 Safari/537.36"] Unable to find the current binding.
----

==== Authorization

.Log Identifier
[width="50%", options="header"]
|===
|Field |Value
|PROC_ID |ACCESS
|COMPONENT |AUTHN
|SUB-COMPONENT |SAML
|EVENT |USER_AUTZ
|===

.Structured Data
[width="100%", cols="2,5", options="header"]
|===
|Field |Description
|SESSION_ID |This is an internal session ID created for the user session. This can be used to track user activity.
|SUBJECT |Username from session
|RESOURCE |The URI being accessed
|POLICY |Name of the policy
|POLICY_TYPE |Type of policy
|DURATION |Time it takes to execute the policy
|APP |Application name
|APP_TYPE |The type of SPGW application being used
|APP_DOMAIN |Public domain of the requested application
|RESULT |ALLOW/DENY
|REASON |Defined policy
|REMOTE_IP |User remote IP address
|USER_AGENT |User browser info
|MSG |The end user message
|===

. Access resource allow
.. *Log Level*: INFO
.. *RESULT*: ALLOW
.. *Message*: Allow access to resource
.. *Log Sample*:
+
----
Oct  5 22:57:05 spgateway01 SPGATEWAY ACCESS AUTHZ POLICY INFO USER_AUTHZ [SESSION_ID="_6f89fde9801702d4055216fad847dc889536592839" SUBJECT="<User login name>" RESOURCE="/" METHOD="GET" POLICY="root" POLICY_TYPE="PROTECTED" DURATION="0" APP="Sample Header App" APP_TYPE="SAMPLEHEADER2015_APP" APP_DOMAIN="<App Domain URL>" RESULT="ALLOW" REASON="N/A - SESSIONID=_6f89fde9801702d4055216fad847dc889536592839 RelayDomain=<App Domain URL> static_a=aaaaa static-b=bbbbb staticc=ccccc _staticd=ddddd -statice=eeeee staticcookie=1234 secret=secretvalue spgw_username=<User login name> UserName=<User login name> spgw_username2=<User login name> login=<User login name> firstname=<User first name> lastname=<User last name> email=<User login name> samplecookie<User first name> Groups=Everyone:Group A:Group C:Group E:Group B:SPGW_CI: SourceAuthNType=urn:oasis:names:tc:SAML:2.0:ac:classes:PasswordProtectedTransport RemoteIP=192.168.10.20 USER_AGENT=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/61.0.3163.100 Safari/537.36 " REMOTE_IP="" USER_AGENT="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/61.0.3163.100 Safari/537.36"] allow access to resource
----
+
. Access resource deny
.. *Log Level*: INFO
.. *RESULT*: DENY
.. *Message*: Allow access to resource
.. *Log Sample*:
+
----
Oct  5 23:47:05 spgateway01 SPGATEWAY ACCESS AUTHZ POLICY INFO USER_AUTHZ [SESSION_ID="_4a3fdbbc52dadda2109e0e789098f9b473d4f68c7e" SUBJECT="<User login name>" RESOURCE="/alt" METHOD="GET" POLICY="altroot" POLICY_TYPE="PROTECTED_REGEX" DURATION="0" APP="Sample Header App" APP_TYPE="SAMPLEHEADER2015_APP" APP_DOMAIN="<App Domain URL>" RESULT="DENY" REASON="Groups=(?!.*Everyone:) - SESSIONID=_4a3fdbbc52dadda2109e0e789098f9b473d4f68c7e RelayDomain=<App Domain URL> static_a=aaaaa static-b=bbbbb staticc=ccccc _staticd=ddddd -statice=eeeee staticcookie=1234 secret=secretvalue spgw_username=<User login name> UserName=<User login name> spgw_username2=<User login name> login=<User login name> firstname=<User first name> lastname=<User last name> email=<User login name> samplecookie<User first name> Groups=Everyone:Group A:Group C:Group E:Group B:SPGW_CI: SourceAuthNType=urn:oasis:names:tc:SAML:2.0:ac:classes:PasswordProtectedTransport RemoteIP=192.168.10.20 USER_AGENT=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/61.0.3163.100 Safari/537.36 creationTime=1507265129865 maxInactiveInterval=3600000 maxActiveInterval=28800000 lastAccessedTime=1507265129865 " REMOTE_IP="" USER_AGENT="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/61.0.3163.100 Safari/537.36"] deny access to resource
----

==== User Session

.Log Identifier
[width="50%", options="header"]
|===
|Field |Value
|PROC_ID |ACCESS
|COMPONENT |AUTHN
|SUB-COMPONENT |SAML
|EVENT |USER_SESSION
|===

.Structured Data
[width="100%", cols="2,5", options="header"]
|===
|Field |Description
|SESSION_ID |This is an internal session ID created for the user session. This can be used to track user activity.
|SESSION_AUTH |The authSession that was used to create this session.
|SESSION_APP |Only used on authSession upgraded.
|SUBJECT |User from session
|APP |Application name
|APP_TYPE |The type of SPGW application being used
|APP_DOMAIN |Public domain of the requested application
|RESULT |ALLOW/DENY
|REASON |Defined policy
|REMOTE_IP |User remote IP address
|USER_AGENT |User browser info
|MSG |The end user message
|===

. AuthSession upgrade with valid authCookie
.. *Log Level*: INFO
.. *Message*: Upgraded auth cookie. App session created.
.. *REASON*: VALID_AUTHCOOKIE
.. *Log Sample*:
+
----
Oct  5 22:57:05 spgateway01 SPGATEWAY ACCESS AUTHZ SESSION INFO USER_SESSION [SESSION_ID="_6f89fde9801702d4055216fad847dc889536592839" SESSION_AUTH="_99077d998f2b3c0f65ee8dbea6abd1fb389a6e18a4" SESSION_APP="e701ddf534554eab8ea671e884438b99" SUBJECT="<User login name>" APP="Sample Header App" APP_TYPE="SAMPLEHEADER2015_APP" APP_DOMAIN="<App Domain URL>" RESULT="ALLOW" REASON="VALID_AUTHCOOKIE" REMOTE_IP="" USER_AGENT="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/61.0.3163.100 Safari/537.36"] Upgraded auth cookie. App session created.
----
+
. AuthSession upgrade with bad authCookie
.. *Log Level*: WARN
.. *REASON*: INVALID_AUTHCOOKIE
.. *Message*: This should be investigated by your security group
.. *Log Sample*:
+
----
Oct  6 10:53:16 spgateway01 SPGATEWAY ACCESS AUTHZ SESSION WARN USER_SESSION [SESSION_ID="" SESSION_AUTH="_131f081ec97099fd2e3268033f859901b17da1247d" APP="Sample Header App" APP_TYPE="SAMPLEHEADER2015_APP" APP_DOMAIN="<App Domain URL>" RESULT="DENY" REASON="INVALID_AUTHCOOKIE" REMOTE_IP="" USER_AGENT="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/61.0.3163.100 Safari/537.36"] This should be investigated by your security group
----
+
. Access application with non-existing sessionCookie
.. *Log Level*: INFO
.. *REASON*: NOT_EXIST
.. *Message*: No session cookie. Sending to handler.
.. *Log Sample*:
+
----
Oct  6 10:12:01 spgateway01 SPGATEWAY ACCESS AUTHZ SESSION INFO USER_SESSION [SESSION_ID="" APP="Sample Header App" APP_TYPE="SAMPLEHEADER2015_APP" APP_DOMAIN="<App Domain URL>" RESULT="DENY" REASON="NOT_EXIST" REMOTE_IP="" USER_AGENT="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/61.0.3163.100 Safari/537.36"] No session cookie. Sending to handler.
----
+
. Session integrity failure (Remote IP)
.. *Log Level*: WARN
.. *RESULT*: DENY
.. *REASON*: SESSION_INTEGRITY_REMOTEIP_MISMATCH
.. *Message*: SRF Request RemoteIP (x-forwarded-for): <New IP Address> failed to match session RemoteIP: <Old IP Address>
.. *Log Sample*:
+
----
Oct  6 13:01:15 spgateway01 sampleheaderappamar 2017/10/06 13:01:15 [warn] 14220#0: *53 using uninitialized "messagetitle" variable, client: 192.168.10.165, server: <App Domain URL>, request: "GET / HTTP/1.1", host: "<App Domain URL>", referrer: "https://<IDP URL>/app/template_saml_2_0/exkca4yif7Qpdc6en0h7/sso/saml"
Oct  6 13:01:15 spgateway01 SPGATEWAY ACCESS AUTHZ SESSION WARN USER_SESSION [SESSION_ID="_b3982440f0ad73e954ed7d4fb2db00cfdbb997200c" SUBJECT="<User login name>" APP="Sample Header App" APP_TYPE="SAMPLEHEADER2015_APP" APP_DOMAIN="<App Domain URL>" RESULT="DENY" REASON="SESSION_INTEGRITY_REMOTEIP_MISMATCH" REMOTE_IP="192.168.25.154" USER_AGENT="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/61.0.3163.100 Safari/537.36"] SRF Request RemoteIP (x-forwarded-for): 192.168.25.154 failed to match session RemoteIP: 192.168.10.165
----
+
. Session integrity failure (Domain mismatch)
.. *Log Level*: ALERT
.. *RESULT*: DENY
.. *REASON*: SESSION_INTEGRITY_DOMAIN_MISMATCH
.. *Message*: Request domain:<Request Domain> does not match session Domain:<Relay Domain>
.. *Log Sample*:
+
----
Oct  6 14:09:37 spgateway01 sampleheaderappamar <App Domain URL> 192.168.10.165 - - [06/Oct/2017:14:09:37 -0500] "GET / HTTP/1.1" 405 1942 "https://<IDP URL>/app/template_saml_2_0/exkca4yif7Qpdc6en0h7/sso/saml" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/61.0.3163.100 Safari/537.36" "-" 0.000 - .
Oct  6 14:09:37 spgateway01 SPGATEWAY ACCESS AUTHZ SESSION ALERT USER_SESSION [SESSION_ID="_4cf89806b42002974d023790cbf9b40a2b32a43d38" SUBJECT="<User login name>" APP="Sample Header App" APP_TYPE="SAMPLEHEADER2015_APP" APP_DOMAIN="<App Domain URL>" RESULT="DENY" REASON="SESSION_INTEGRITY_DOMAIN_MISMATCH" REMOTE_IP="" USER_AGENT="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/61.0.3163.100 Safari/537.36"] Request domain:<App Domain URL> does not match session Domain:header.icsynergy.com
----

==== Authentication and Session Handling
This section describes the normal flow of authentication that can be tracked using the audit logs to troubleshoot session-related issues.
Every user session is assigned a unique session ID.
This session ID can also be used to trace a user session and can be helpful in troubleshooting or debugging.

Here is the basic flow of authentication and session creation along with the sequence of audit logs that are generated:

. Browser sends request to SPGateway to access an application. SPGateway checks if a session already exists, then redirects the browser to IDP for authentication.
+
----
Nov  1 22:46:11 spgateway01 SPGATEWAY ACCESS AUTHZ SESSION INFO USER_SESSION [SESSION_ID="" APP="Sample Header App" APP_TYPE="SAMPLEHEADER2015_APP" APP_DOMAIN="<App Domain URL>" RESULT="DENY" REASON="NOT_EXIST" REMOTE_IP="" USER_AGENT="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.62 Safari/537.36"] No session cookie. Sending to handler.
----
+
. User is presented the login page by IDP, enters credentials, and submits the form. Upon successful authentication, browser posts SAML assertion to SPGateway, and SPGateway validates the assertion and authenticates the user. Upon successful authentication, SPGateway creates a new session, assigns a new session ID to the session, and stores SAML attributes to the cache. SPGateway also sends the domain session cookie to the browser.
+
----
Nov  1 22:46:37 spgateway01 SPGATEWAY ACCESS AUTHN SAML INFO USER_AUTHN [SESSION_ID="_3e9bf6939e3724d6af7844505971d0d52f05cb932d" SESSION_AUTH="_7a0cc86a711ad61bf760a3de582a0f1780a8796359" SUBJECT="<User login name>" TYPE="SAML_2_0" SOURCE="http://www.okta.com/exkco438bkIFqvPfn0h7" SOURCE_TYPE="<Identity Provider type>" SOURCE_DOMAIN="<IDP URL>" SOURCE_AUTHN_TYPE="urn:oasis:names:tc:SAML:2.0:ac:classes:PasswordProtectedTransport" APP="Sample Header App" APP_DOMAIN="<App Domain URL>" RESULT="PASS" REASON="Valid SAML Assertion" REMOTE_IP="192.168.10.20" USER_AGENT="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.62 Safari/537.36"] User login:<User login name>
----
+
. The browser requests the application again with the session cookie. SPGateway verifies the session integrity and sends the user to an error page if any issues are found with the session; otherwise, it proceeds to processing the request.
+
----
Nov  1 22:46:37 spgateway01 icsIcsgwAccess <host URL> 192.168.10.20 - - [01/Nov/2017:22:46:37 -0500] "POST /auth/module.php/saml/sp/saml2-acs.php/default-sp HTTP/1.1" 303 601 "https://<IDP URL>/app/template_saml_2_0/exkco438bkIFqvPfn0h7/sso/saml?RelayState=https%3A%2F%2F<App Domain URL>%2F" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.62 Safari/537.36" "-" 0.184 0.164 .
Nov  1 22:46:37 spgateway01 SPGATEWAY ACCESS AUTHZ SESSION INFO USER_SESSION [SESSION_ID="_3e9bf6939e3724d6af7844505971d0d52f05cb932d" SUBJECT="<User login name>" APP="Sample Header App" APP_TYPE="SAMPLEHEADER2015_APP" APP_DOMAIN="<App Domain URL>" RESULT="ALLOW" REASON="SESSION_INTEGRITY_VERIFIED" REMOTE_IP="" USER_AGENT="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.62 Safari/537.36"] SRF Request RemoteIP:  verified session RemoteIP: 192.168.10.20
----
+
. SPGateway destroys the domain session cookie and creates an FQDN application cookie.
+
----
Nov  1 22:46:37 spgateway01 SPGATEWAY ACCESS AUTHZ SESSION INFO USER_SESSION [SESSION_ID="_3e9bf6939e3724d6af7844505971d0d52f05cb932d" SESSION_AUTH="_7a0cc86a711ad61bf760a3de582a0f1780a8796359" SESSION_APP="7303a91083a04a34bab3c22c54c769ae" SUBJECT="<User login name>" APP="Sample Header App" APP_TYPE="SAMPLEHEADER2015_APP" APP_DOMAIN="<App Domain URL>" RESULT="ALLOW" REASON="VALID_AUTHCOOKIE" REMOTE_IP="" USER_AGENT="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.62 Safari/537.36"] Upgraded auth cookie. App session created.
----
+
. SPGateway gets the attributes from the session cache, injects attributes to the header, and allows access to the application. Application request is sent back to the browser with an FQDN session cookie.
+
----
Nov  1 22:46:37 spgateway01 SPGATEWAY ACCESS AUTHZ POLICY INFO USER_AUTHZ [SESSION_ID="_3e9bf6939e3724d6af7844505971d0d52f05cb932d" SUBJECT="<User login name>" RESOURCE="/" METHOD="GET" POLICY="root" POLICY_TYPE="PROTECTED" DURATION="0" APP="Sample Header App" APP_TYPE="SAMPLEHEADER2015_APP" APP_DOMAIN="<App Domain URL>" RESULT="ALLOW" REASON="N/A - SESSIONID=_3e9bf6939e3724d6af7844505971d0d52f05cb932d RelayDomain=<App Domain URL> static_a=aaaaa static-b=bbbbb staticc=ccccc _staticd=ddddd -statice=eeeee staticcookie=1234 secret=secretvalue spgw_username=<User login name> UserName=<User login name> spgw_username2=<User login name> login=<User login name> firstname=<User first name> lastname=<User last name> email=<User login name> samplecookie<User first name> Groups=Everyone:Group A:Group C:Group B:SPGW_CI:Group E: SourceAuthNType=urn:oasis:names:tc:SAML:2.0:ac:classes:PasswordProtectedTransport RemoteIP=192.168.10.20 USER_AGENT=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.62 Safari/537.36 " REMOTE_IP="" USER_AGENT="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.62 Safari/537.36"] allow access to resource
----
+
As shown in the example above, the unique session ID is logged by all audit logs and can be used to track a specific user session.

=== Process Monitor

==== NGINX Configuration

.Log Identifier
[width="50%", options="header"]
|===
|Field |Value
|PROC_ID |SPGW_MONITOR
|COMPONENT |MONITOR
|SUB-COMPONENT |NGINX
|EVENT |USER_SESSION
|===

.Structured Data
[width="100%", cols="2,5", options="header"]
|===
|Field |Description
|STATUS |NGINX configuration status codes are defined below
|===

. NGINX Configuration check
.. *Log Level, STATUS*:
+
[width="100%", cols="2,1,2", options="header"]
|===
|Status Code |Log Level |Description
|VALID |INFO |
|CONFLICTING_SERVER_NAME |WARN |Duplicate server name
|SUSPICIOUS_SYMBOL |WARN |Line note ended or suspicious symbol in configuration file
|UNKNOWN_WARNING |WARN |Any unknown warning
|HOST_NOT_FOUND |ERROR |Host not resolved
|UNKNOWN_DIRECTIVE |ERROR |Unknown directive found
|INVALID_PARAMETER |ERROR |Invalid parameter found or missing `;`
|DUPLICATE_LOCATION |ERROR |Duplicate location block
|UNEXPECTED_END_OF_FILE |ERROR |File not complete or missing `}`
|UNKNOWN_ERROR |ERROR |Any unhandled error
|===
+
.. *Message*: NGINX test output
.. *Log Sample*:
+
----
Oct  9 15:52:52 spgateway01 SPGATEWAY SPGW_MONITOR MONITOR NGINX INFO CONFIG_TEST [STATUS="VALID"] NGINX configuration is valid
----

==== NGINX Application Configuration

.Log Identifier
[width="50%", options="header"]
|===
|Field |Value
|PROC_ID |SPGW_MONITOR
|COMPONENT |MONITOR
|SUB-COMPONENT |NGINX
|EVENT |USER_SESSION
|===

.Structured Data
[width="100%", cols="2,5", options="header"]
|===
|Field |Description
|STATUS |NGINX configuration status codes are defined below
|UUID |Application identifier
|===

. NGINX application configuration check
.. *Log Level, STATUS*:
+
[width="100%", cols="2,1,2", options="header"]
|===
|Status Code |Log Level |Description
|VALID |INFO |
|CONFLICTING_SERVER_NAME |WARN |Duplicate server name
|SUSPICIOUS_SYMBOL |WARN |Line note ended or suspicious symbol in configuration file
|UNKNOWN_WARNING |WARN |Any unknown warning
|HOST_NOT_FOUND |ERROR |Host not resolved
|UNKNOWN_DIRECTIVE |ERROR |Unknown directive found
|INVALID_PARAMETER |ERROR |Invalid parameter found or missing `;`
|DUPLICATE_LOCATION |ERROR |Duplicate location block
|UNEXPECTED_END_OF_FILE |ERROR |File not complete or missing `}`
|UNKNOWN_ERROR |ERROR |Any unhandled error
|===
+
.. *Message*: NGINX test output
.. *Log Sample*:
+
----
Oct  9 15:52:59 spgateway01 SPGATEWAY SPGW_MONITOR MONITOR NGINX INFO CONFIG_TEST [STATUS="VALID" UUID="9179e919-43dc-4396-8b26-164387213b1b"] nginx: the configuration file /tmp/nginx/nginx.conf syntax is ok nginx: configuration file /tmp/nginx/nginx.conf test is successful
----

==== SSL Certificate
.Log Identifier
[width="50%", options="header"]
|===
|Field |Value
|PROC_ID |SPGW_MONITOR
|COMPONENT |MONITOR
|SUB-COMPONENT |CERT_CHECK
|EVENT |SSL_CERT_VALIDITY_CHECK
|===

.Structured Data
[width="100%", cols="2,5", options="header"]
|===
|Field |Description
|USER |Username
|EXPIRY |Certificate expiration date in YYYYMMDD format
|===

. Certificate check
.. *Log Level, STATUS*:
+
[width="100%", cols="2,1,2", options="header"]
|===
|Status Code |Log Level |Description
|VALID |INFO | SSL Certificate is valid for more than 30 days
|EXPIREIN30DAYS |WARN |SSL Certificate is going to expire in 30 days or less
|EXPIRED |ERROR |SSL Certificate has expired
|ERROR |ERROR |SSL Certificate not found
|===
+
.. *Log Sample*:
+
----
Oct  9 15:51:18 spgateway01 SPGATEWAY SPGW_MONITOR MONITOR CERT_CHECK INFO SSL_CERT_VALIDITY_CHECK [USER="<Username>" EXPIRY="20191009"] SSL Certificate is valid for more than 30 days
----

==== Auth Modules
.Log Identifier
[width="50%", options="header"]
|===
|Field |Value
|PROC_ID |SPGW_MONITOR
|COMPONENT |MONITOR
|SUB-COMPONENT |AUTH_MODULE
|EVENT |TEST_AUTHN_AD  TEST_AUTHN LDAP
|===

.Structured Data
[width="100%", cols="2,5", options="header"]
|===
|Field |Description
|STATUS |Status Code
|UUID |Auth module identifier
|HOST |LDAP/AD host
|PORT |LDAP port
|USER_SEARCH_BASE_DN |User search base DN
|SEARCH_ATTRIBUTE |Search attribute
|===

. Auth module check
.. *Log Level, STATUS*:
+
[width="100%", cols="2,1,2", options="header"]
|===
|Status Code |Log Level |Description
|VALID |INFO | Auth module is valid
|LDAP_ERROR_CONNECTION_REFUSED |WARN |Host <Hostname> is not available
|LDAP_INVALID_SEARCHBASE |ERROR |User Search Base was not found
|LDAP_INVALID_USERBASE | ERROR |User Search Base was not found
|LDAP_ERROR_INVALID_CREDENTIALS |ERROR |Invalid credentials
|LDAP_ERROR_SEARCH_ATTRIBUTE |ERROR |Invalid User Search Attribute
|UNKNOWN_ERROR |ERROR |Error validating <Hostname> Settings
|===
+
.. *Log Sample*:
+
----
Oct  9 15:53:05 spgateway01 SPGATEWAY SPGW_MONITOR MONITOR AUTH_MODULE INFO TEST_AUTHN_AD [STATUS="LDAP_VALID" UUID="a185d793-4538-4e5f-9deb-46eb40850aba" HOST="<Host IP Address>" PORT="389" USER_SEARCH_BASE_DN="cn=Users,dc=icsynergy,dc=info" SEARCH_ATTRIBUTE="samaccountname"] Auth module is valid
----

=== Access Log

.Access Log
[width="100%", cols="2,5", options="header"]
|===
|Field |Description
|Hostname |Hostname of SPGateway appliance
|Tag |Tag to identify SPGateway component
|Application Hostname |Hostname of the application (public domain of application)
|Client IP |User's IP address
|Timestamp |Date and time when request was processed
|Request |HTTP request
|HTTP Status Code |HTTP status code
|Request size |Size of request body in bytes
|HTTP Referrer |
|User Agent |Browser information
|X-Forwarded-For |X-Forwarded-For header received
|Request Time |Time in seconds to receive request
|Response Time |Time in seconds to send a response
|===

*Log Sample*:

----
Mar 28 13:13:57 spgateway01 sampleheaderapptest <App Domain URL> <User's IP Address> - - [28/Mar/2018:13:13:57 -0500] "GET / HTTP/1.1" 200 4828 "-" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/65.0.3325.181 Safari/537.36" "<User's IP Address>" 0.006 0.001 .
----

The following table identifies the data captured in the log sample above:

.Access log sample
[width="100%", cols="2,5", options="header"]
|===
|Field |Value
|Hostname |<SPGateway hostname>
|Tag |sampleheaderapptest
|Application Hostname |<App Domain URL>
|Client IP |<User's IP Address>
|Timestamp |28/Mar/2018:13:13:57 -0500
|Request |GET /HTTP/1.1
|HTTP Status Code |200
|Request size |4821
|HTTP Referrer |-
|User Agent |Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/65.0.3325.181 Safari/537.36
|X-Forwarded-For |<User's IP Address>
|Request Time |0.006
|Response Time |0.001
|===

=== HTTP Status Codes

SPGateway returns the following status codes to the browser in any event. They are also captured in the access log for troubleshooting any issues.

include::fragments/frag-http-status-codes.adoc[]

== Log Rotation and Archival

. SPGateway is configured to rotate logs daily.
. Default setup stores the log files for a month and deletes old log files to save disk space.
. A service ticket can be opened for link:https://icsynergy.freshdesk.com/[ICSynergy Support] to update the log rotation and archival configuration as per your requirements.
